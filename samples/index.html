<!DOCTYPE html>
<html ng-app="myApp">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>
    <%= htmlWebpackPlugin.options.title %>
  </title>
  <meta name="description" content="<%= htmlWebpackPlugin.options.title %>">
</head>

<body>
  <div class="player">

  </div>

  <div ng-controller="myCtrl">
    <div class="row" ng-if="isMp4">
      <div class="panel panel-default">
        <div class="col-md-3">
          <treecontrol class="tree-light" tree-model="mp4Atoms" options="treeOptions" on-selection="showSelected(node)">
            {{node.type}} ({{node.size}} bytes)
          </treecontrol>
        </div>
        <div class="col-md-9">
          <ul>
            <li ng-repeat="(key, value) in selectedNode" ng-if="key !== 'atoms' && key !== 'containerDataOffset'">
              {{key}}: {{value}}
            </li>
          </ul>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-9">
        <div class="panel panel-default">
          <ul>
            <li ng-repeat="(key, value) in tracks">
              Track #{{value.id}} - {{value.getMimeType()}}
              <ul>
                <li ng-repeat="frame in value.getFrames()">
                  <div ng-class="{text_type_bold: frame.frameType === 'I' }">{{frame.timeUs / 1000000 | number: 2}} s - {{frame.frameType}}</div>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <video id="video"></video>

  <script>
    let app = angular.module('myApp', ['treeControl']);
    app.controller('myCtrl', function ($scope, $http) {
      $scope.treeOptions = {
        nodeChildren: 'atoms'
      };

      $scope.showSelected = function (sel) {
        $scope.selectedNode = sel;
      };

      var mediaSampleUrl = 'http://localhost/dash/chunk_video.m4s';
      $scope.isMp4 = true;

      //var mediaSampleUrl = 'http://localhost/test/mp3_sample.ts';
      //$scope.isMp4 = false;

      var oReq = new XMLHttpRequest();
      var demuxer = $scope.isMp4 ? inspectorjs.createMp4Demuxer() : inspectorjs.createMpegTSDemuxer();
      $http.get(mediaSampleUrl, {
        responseType: 'arraybuffer'
      }).then(function successCb(response) {
        let arrayBuffer = response.data; // Note: not oReq.responseText
        if (arrayBuffer) {
          var byteArray = new Uint8Array(arrayBuffer);
          demuxer.append(byteArray);
          demuxer.end();
          if ($scope.isMp4) {
            $scope.mp4Atoms = demuxer.atoms;
          }
          $scope.tracks = demuxer.tracks;
        }
      }, function errorCb(response) {
        console.log('Error: ' + response);
      });
    });
  </script>
</body>

</html>